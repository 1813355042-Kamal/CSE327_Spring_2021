<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="float.css">

    <script src="https://kit.fontawesome.com/7bf1794c28.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <!-- Mapbox Scripts-->

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
    </style>
  </head>
  <body>
            <script>
                var placedmarker = false;
                var Cursor;
                var CursorLat;
                var CursorLng;

            </script>

                <div id="map"></div>
                <div id="clickmarker"></div>
                <a href="#" class="float" onclick="triggerRegisterNewHousePopup()"> <i class="fa fa-home my-float"></i> </a>
                <div class="label-container"> <div class="label-text">Register New House</div> <i class="fa fa-play label-arrow"></i> </div>

            <script>
                mapboxgl.accessToken = 'pk.eyJ1IjoidGhlc2FsbWFuc2FoZWwiLCJhIjoiY2toNHVqNjd4MGZmcDJ4b3Zzdm02bzJlcyJ9.TqZwgHJ7WGvn876yNRN_4w';
                var map = new mapboxgl.Map({
                    container: 'map', // container ID
                    style: 'mapbox://styles/mapbox/streets-v11', // style URL
                    center: [90.41, 23.78], // starting position [lng, lat]
                    zoom: 12 // starting zoom
                });

                // GeoJSON object to hold our measurement features
                var geojson = {
                    'type': 'FeatureCollection',
                    'features': []
                };

                map.on('load', function () {
                    map.addSource('geojson', {
                        'type': 'geojson',
                        'data': geojson
                    });

                    // Add styles to the map
                    map.addLayer({
                        id: 'cursor-layer',
                        type: 'circle',
                        source: 'geojson',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': '#E00'
                        },
                        filter: ['in', '$type', 'Point']
                    });


                    map.on('click', function (e) {
                        var features = map.queryRenderedFeatures(e.point);
                        if(placedmarker){
                        	geojson.features=[];
                            placedmarker=false;
                        }
                        else{
                        	placedmarker= true;
                            var point = {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [e.lngLat.lng, e.lngLat.lat]
                                },
                                'properties': {
                                    'id': 'cursor'
                                }
                            };
                            CursorLat=e.lngLat.lat;
                            CursorLng=e.lngLat.lng;
                            geojson.features.push(point);
                        }
                        map.getSource('geojson').setData(geojson);
                    });
                });

            </script>

          <!--Start of Nav Bar-->
          <nav class="navbar navbar-expand-sm navbar-dark bg-black">
          <div class="container">
              <a href="index.html" class="navbar-brand">BharaTiya</a>

            <div class="collapse navbar-collapse "id="navbarCollapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a href="map.html" class="nav-link">Map</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">Services</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">About Us</a>
                    </li>

                </ul>
            </div>
          </div>
          </nav>
          <script>
          function triggerRegisterNewHousePopup(){
              if(!placedmarker) return;
              document.getElementById("registerhousepopup").style.display = "flex";
          }
          function closeRegisterNewHousePopup(){
              document.getElementById("registerhousepopup").style.display = "none";
          }
          function registerNewHouse(){
              addHouseinDB();
          }
          </script>
          <div class="popup" id="registerhousepopup">
              <div class="popup-content">
                  <p class="lead">Register new house</p>
                  <input type="text" placeholder= "House Name" id="housename"></input>
                  <input type="text" placeholder= "Rent" id="rent"></input>
                  <input type="text" placeholder= "Number of Bedrooms" id="bedrooms"></input>
                  <input type="text" placeholder= "Number of Bathrooms" id="bathrooms"></input>
                  <a href="#" class="btn btn-register" onclick="registerNewHouse()">
                     Register
                  </a>
                  <a href="#" class="btn btn-exit" onclick = "closeRegisterNewHousePopup()">
                     Exit
                  </a>
              </div>
          </div>
          <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-app.js"></script>

          <!-- Add Firebase products that you want to use -->
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-auth.js"></script>
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-firestore.js"></script>
          <script>

            var firebaseConfig = {
              apiKey: "AIzaSyD22caki0Faq_SvkK_hEb6Hzbo1xUzARSY",
              authDomain: "cse327-22a1f.firebaseapp.com",
              projectId: "cse327-22a1f",
              storageBucket: "cse327-22a1f.appspot.com",
              messagingSenderId: "655530972906",
              appId: "1:655530972906:web:fe3b9ddfeba0926b14a993",
              measurementId: "G-CFTDRQSXCD"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
          </script>
          <!--end of Firebase references-->

          <!--Required for firestore-->
          <script>
          var db = firebase.firestore();
          </script>
          <!--End of firestore references-->

          <script>
                //This handles the house registration system.
                function addHouseinDB(){
                    var _housename = document.getElementById("housename").value;
                    var _rent = document.getElementById("rent").value;
                    var _bedrooms = document.getElementById("bedrooms").value;
                    var _bathrooms = document.getElementById("bathrooms").value;

                    if(_housename == "" || rent=="" || bedrooms == "" || bathrooms == "") return;

                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            db.collection("Users").doc(user.uid).collection("houses").add({
                                name: _housename,
                                rent: _rent,
                                bedrooms: _bedrooms,
                                bathrooms: _bedrooms,
                                Lat: CursorLat,
                                Lng: CursorLng
                            })
                            .then(() => {
                                console.log("Document successfully written!");
                            })
                            .catch((error) => {
                                console.error("Error writing document: ", error);
                            });
                            closeRegisterNewHousePopup();
                        } else {
                            window.alert("No user.");
                        }
                    });
                }

          </script>


  </body>

</html>
