<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="float.css">


    <script src="https://kit.fontawesome.com/7bf1794c28.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <!-- Mapbox Scripts-->

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
    </style>
  </head>
  <body>
            <script>
                var placedmarker = false;
                var Cursor;
                var CursorLat;
                var CursorLng;
                var currentHouse;
                var myMessages = [];
            </script>


                <div id="map"></div>
                <div id="clickmarker"></div>
                <a href="#" class="float" onclick="triggerRegisterNewHousePopup()"> <i class="fa fa-home my-float"></i> </a>

                <!-- div class="label-container"> <div class="label-text">Register New House</div> <i class="fa fa-play label-arrow"></i> </div -->

                <a href="#" class="floaty" onclick="triggerFilterPopup()" id= "filterenter"> <i class="fa fa-gear my-float"></i> </a>

                <a href="#" class="floatx" onclick="triggerNotificationsPopup()"> <i class="fa fa-bell my-float"></i> </a>

          <!--Start of Nav Bar-->
          <nav class="navbar navbar-expand-sm navbar-dark bg-black">
          <div class="container">
              <a href="index.html" class="navbar-brand">BharaTiya</a>
            <div class="collapse navbar-collapse "id="navbarCollapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a href="map.html" class="nav-link">Map</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">Services</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">About Us</a>
                    </li>

                </ul>
            </div>
          </div>
          </nav>
          <script>
          function triggerRegisterNewHousePopup(){
              if(!placedmarker) return;
              document.getElementById("registerhousepopup").style.display = "flex";
          }
          function closeRegisterNewHousePopup(){
              document.getElementById("registerhousepopup").style.display = "none";
          }
          function triggerFilterPopup(){
              document.getElementById("filterpopup").style.display = "flex";
          }
          function closeFilterPopup(){
              document.getElementById("filterpopup").style.display = "none";
          }

          async function triggerNotificationsPopup(){              
              await getNotificationsFromDatabase();
              document.getElementById("notif").style.display = "flex";
          }

          function closeNotifications(){
             document.getElementById("notif").style.display = "none";
          }

          function triggerHousePopup(house){

              document.getElementById("housepopup_name").innerHTML = "House Name: "+ house.name;
              document.getElementById("housepopup_rent").innerHTML = "Rent: "+house.rent;
              document.getElementById("housepopup_bedrooms").innerHTML = "Bedrooms: "+house.bedrooms;
              document.getElementById("housepopup_bathrooms").innerHTML = "Bathrooms: "+house.bathrooms;
              document.getElementById("displayhouseinfopopup").style.display = "flex";

          }
          function closeHousePopup(house){
              document.getElementById("displayhouseinfopopup").style.display = "none";
          }
          function registerNewHouse(){
              addHouseinDB();
          }
          </script>
          <div class="popup" id="registerhousepopup">
              <div class="popup-content">
                  <p class="lead">Register new house</p>
                  <input type="text" placeholder= "House Name" id="housename"></input>
                  <input type="text" placeholder= "Rent" id="rent"></input>
                  <input type="text" placeholder= "Number of Bedrooms" id="bedrooms"></input>
                  <input type="text" placeholder= "Number of Bathrooms" id="bathrooms"></input>
                  <a href="#" class="btn btn-register" onclick="registerNewHouse()">
                     Register
                  </a>
                  <a href="#" class="btn btn-exit" onclick = "closeRegisterNewHousePopup()">
                     Exit
                  </a>
              </div>
          </div>

          <div class="popup" id="notif"><!--Notifications popup-->
            <div class="popup-notif">
                <p class="lead">Notifications</p>
                <ul class="msglisg" id ="notificationmessages">
                </ul>
                <br>
                <a href="#" class="btn btn-exit" onclick="closeNotifications()">
                   Exit
                </a>
            </div>
          </div>
          <div class="popup" id="displayhouseinfopopup">
              <div class="popup-content">
                  <p class="lead" id= "housepopup_name">Sample House Name</p>
                  <p class="lead" id= "housepopup_rent">Rent: 69</p>
                  <p class="lead" id= "housepopup_bedrooms">Bedrooms: 4</p>
                  <p class="lead" id= "housepopup_bathrooms">Bathrooms: 20</p>
                  <br><br><br><br><br><br>

                  <a href="#" class="btn btn-register" onclick="clickInterested()">
                     Interested
                  </a>
                  <a href="#" class="btn btn-exit" onclick = "closeHousePopup()">
                     Exit
                  </a>
              </div>
          </div>
          <div class="popup" id="filterpopup">
              <div class="popup-content">
                  <p class="lead">Filter Houses</p>

                  <input type="text" placeholder= "Min Rent" id="minrent"></input>
                  <input type="text" placeholder= "Max Rent" id="maxrent"></input>

                  <input type="text" placeholder= "Min Rooms" id="minrooms"></input>
                  <input type="text" placeholder= "Max Rooms" id="maxrooms"></input>

                  <a href="#" class="btn btn-register" onclick="filterQuery()">
                     Ok
                  </a>
                  <a href="#" class="btn btn-exit" onclick = "closeFilterPopup()">
                     Exit
                  </a>
              </div>
          </div>
          <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-app.js"></script>

          <!-- Add Firebase products that you want to use -->
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-auth.js"></script>
          <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-firestore.js"></script>
          <script>

            var firebaseConfig = {
              apiKey: "AIzaSyD22caki0Faq_SvkK_hEb6Hzbo1xUzARSY",
              authDomain: "cse327-22a1f.firebaseapp.com",
              projectId: "cse327-22a1f",
              storageBucket: "cse327-22a1f.appspot.com",
              messagingSenderId: "655530972906",
              appId: "1:655530972906:web:fe3b9ddfeba0926b14a993",
              measurementId: "G-CFTDRQSXCD"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
          </script>
          <!--end of Firebase references-->

          <!--Required for firestore-->
          <script>
          var db = firebase.firestore();
          </script>
          <!--End of firestore references-->
          <script>
              mapboxgl.accessToken = 'pk.eyJ1IjoidGhlc2FsbWFuc2FoZWwiLCJhIjoiY2toNHVqNjd4MGZmcDJ4b3Zzdm02bzJlcyJ9.TqZwgHJ7WGvn876yNRN_4w';
              var map = new mapboxgl.Map({
                  container: 'map', // container ID
                  style: 'mapbox://styles/mapbox/streets-v11', // style URL
                  center: [90.41, 23.78], // starting position [lng, lat]
                  zoom: 12 // starting zoom
              });

              // cursorCordinates object to hold our measurement features
              var cursorCordinates = {
                  'type': 'FeatureCollection',
                  'features': []
              };

              var houseJSON = {
                  'type': 'FeatureCollection',
                  'features': []
              };

              map.on('load', function () {

                  map.addSource('cursorCordinates', {
                      'type': 'geojson',
                      'data': cursorCordinates
                  });
                  map.addSource('houseJSON', {
                      'type': 'geojson',
                      'data': houseJSON
                  });

                  map.loadImage(
                      'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
                      function (error, image) {
                          if (error) throw error;
                          map.addImage('custom-marker', image);
                          map.getSource('houseJSON').setData(houseJSON);
                          // Add a symbol layer
                          map.addLayer({
                              'id': 'house-layer',
                              'type': 'symbol',
                              'source': 'houseJSON',
                              'layout': {
                                  'icon-image': 'custom-marker',
                                  // get the title name from the source's "title" property
                                  'text-field': ['get', 'title'],
                                  'text-font': [
                                      'Open Sans Semibold',
                                      'Arial Unicode MS Bold'
                                  ],
                                  'text-offset': [0, 1.25],
                                  'text-anchor': 'top'
                              }
                          });
                      }
                  );
                          // Add styles to the map
                  map.addLayer({
                      id: 'cursor-layer',
                      type: 'circle',
                      source: 'cursorCordinates',
                      paint: {
                          'circle-radius': 5,
                          'circle-color': '#E00'
                      },
                      filter: ['in', '$type', 'Point']
                  });


                  map.on('click', function (e) {
                      var features = map.queryRenderedFeatures(e.point, {
                          layers: ['house-layer'] // Since we're interested in the housing layer, we'll specify it here
                      });

                      if(!features.length){   //No house clicked. handle cursor placement.
                          if(placedmarker){
                              cursorCordinates.features=[];
                              placedmarker=false;
                          }
                          else{
                              placedmarker= true;
                              var point = {
                                  'type': 'Feature',
                                  'geometry': {
                                      'type': 'Point',
                                      'coordinates': [e.lngLat.lng, e.lngLat.lat]
                                  },
                                  'properties': {
                                      'id': 'cursor'
                                  }
                              };
                              CursorLat=e.lngLat.lat;
                              CursorLng=e.lngLat.lng;
                              cursorCordinates.features.push(point);
                          }
                          map.getSource('cursorCordinates').setData(cursorCordinates);
                      }
                      //Clicked on House
                      else{
                          var feature = features[0];
                          currentHouse = feature.properties;
                          triggerHousePopup(feature.properties);
                      }
                  });
              });
          </script>
          <script>
                function clickInterested(){
                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            db.collection("Root/Notification/" + currentHouse.owner).add({'msg': user.email + " is interested in your house named " + currentHouse.name});
                        } else {
                            window.alert("No user.");
                        }
                    });

                }
          </script>
          <script>
                //Updates Map with current data from database.
                function databaseFetch(){
                    houseJSON.features=[];
                    db.collection("Root/HouseList/houses")
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            var house = doc.data();
                            //console.log(house["Lat"], house["Lng"]);
                            var point = {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [house["Lng"], house["Lat"]]
                                },
                                'properties': {
                                    'id': 'house',
                                    'name': house["name"],
                                    'rent': house["rent"],
                                    'bedrooms': house["bedrooms"],
                                    'bathrooms': house["bathrooms"],
                                    'owner': house["owner"]
                                }
                            };
                            houseJSON.features.push(point);
                    });
                    map.getSource('houseJSON').setData(houseJSON);
                    }).catch((error) => {
                        console.log("Error getting documents: ", error);
                    });
                }

                //This handles the house registration system.
                function addHouseinDB(){
                    databaseFetch();
                    var _housename = document.getElementById("housename").value;
                    var _rent = document.getElementById("rent").value;
                    var _bedrooms = document.getElementById("bedrooms").value;
                    var _bathrooms = document.getElementById("bathrooms").value;

                    if(_housename == "" || rent=="" || bedrooms == "" || bathrooms == "") return;

                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            db.collection("Root").doc("HouseList").collection("houses").add({
                                name: _housename,
                                rent: _rent,
                                bedrooms: Number(_bedrooms),
                                bathrooms: Number(_bedrooms),
                                Lat: CursorLat,
                                Lng: CursorLng,
                                owner: user.email
                            })
                            .then((doc) => {
                                //For notifications, access "Root/notifs/user.email"
                                //insert _housename and house doc.id.
                                //to delete notification (and listing), search through Root/HouseList/houses for "doc.id" named listing.
                                db.collection("Root").doc("Users").collection(user.email).add({
                                    id:doc.id
                                }).catch((error) => {
                                    console.error("Error writing document: ", error);
                                });
                            })
                            .catch((error) => {
                                console.error("Error writing document: ", error);
                            });
                            closeRegisterNewHousePopup();

                        } else {
                            window.alert("No user.");
                        }
                    });
                }
                var housesNoFilter;
                function filterQuery(){
                    var minrent=document.getElementById("minrent").value;
                    var maxrent=document.getElementById("maxrent").value;
                    var minrooms=document.getElementById("minrooms").value;
                    var maxrooms=document.getElementById("maxrooms").value;
                    if(minrent=="" ) minrent = -1;
                    if(maxrent=="" ) maxrent = 10000000;
                    if(minrooms=="" ) minrooms = -1;
                    if(maxrooms=="" ) maxrooms = 10000000;
                    minrent= Number(minrent);
                    maxrent= Number(maxrent);
                    minrooms=Number(minrooms);
                    maxrooms=Number(maxrooms);

                    var filterJSON = {
                        'type': 'FeatureCollection',
                        'features': []
                    };
                    console.log(houseJSON);
                    houseJSON.features.forEach((feat, idx) =>{
                        var rent=Number(feat.properties.rent);
                        var rooms=Number(feat.properties.bedrooms);
                        console.log("minrent, rent, maxrent: ", minrent, rent,maxrent);
                        console.log("minrooms, rooms, maxrooms: ", minrooms, rooms,maxrooms);
                        if(minrent <=rent && rent <= maxrent && minrooms<= rooms && rooms <= maxrooms){
                            console.log("satisfies ", rent);
                            filterJSON.features.push(feat);
                        }
                    });
                    map.getSource('houseJSON').setData(filterJSON);
                    closeFilterPopup();
                }

                async function getNotificationsFromDatabase(){
                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            myMessages=[];
                            document.getElementById("notificationmessages").innerHTML="";
                            db.collection("Root/Notification/"+user.email)
                            .get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc, idx) => {
                                    console.log(doc.id);
                                    myMessages.push(doc.data()["msg"]);
                                });
                                myMessages.forEach((msg) => {
                                    document.getElementById("notificationmessages").innerHTML+= "<li class=\"msgItem\">"+msg+"</li>";
                                });
                            })
                            .catch((error) => {
                                console.error("Error in reading" + error);
                            });
                        } else {
                            window.alert("No user.");
                        }
                    });
                }

                </script>


  </body>

</html>
